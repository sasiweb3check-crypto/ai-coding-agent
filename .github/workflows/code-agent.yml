name: AI Coding Agent Workflow

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      topic:
        description: 'Topic for code generation'
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ai-code-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Extract Topic from Issue
        id: extract_topic
        if: github.event_name == 'issues'
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "body=$ISSUE_BODY" >> $GITHUB_OUTPUT
          
          # Check if it's a "Topic:" issue
          if [[ ! "$ISSUE_TITLE" =~ ^Topic: ]]; then
            echo "Not a topic issue, skipping"
            echo "processing=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "processing=true" >> $GITHUB_OUTPUT
          echo "Agent will process: $ISSUE_TITLE"
      
      - name: Extract Topic from Workflow Dispatch
        id: extract_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          TOPIC="${{ inputs.topic }}"
          echo "title=$TOPIC" >> $GITHUB_OUTPUT
          echo "processing=true" >> $GITHUB_OUTPUT
          echo "Agent will process: $TOPIC"
      
      - name: Generate Code with AI Agent
        id: generate
        if: steps.extract_topic.outputs.processing == 'true' || steps.extract_dispatch.outputs.processing == 'true'
        env:
          AI_AGENT_MODEL_API_KEY: ${{ secrets.AI_AGENT_MODEL_API_KEY }}
        run: |
          TOPIC="${{ steps.extract_topic.outputs.title || steps.extract_dispatch.outputs.title }}"
          echo "Processing topic: $TOPIC"
          
          if [ -z "$AI_AGENT_MODEL_API_KEY" ]; then
            echo "ERROR: AI_AGENT_MODEL_API_KEY secret is not set"
            echo "Please add AI_AGENT_MODEL_API_KEY to repository secrets"
            exit 1
          fi
          
          python agent.py "$TOPIC" --output generated-code || {
            echo "Code generation failed"
            exit 1
          }
          
          echo "generation_success=true" >> $GITHUB_OUTPUT
      
      - name: Build & Execute Generated Code
        id: execute
        if: steps.generate.outputs.generation_success == 'true'
        continue-on-error: true
        run: |
          chmod +x scripts/execute.sh
          bash scripts/execute.sh
          echo "execution_success=true" >> $GITHUB_OUTPUT
      
      - name: Prepare Execution Logs
        id: logs
        if: always()
        run: |
          if [[ -f "generated-code/execution.log" ]]; then
            EXEC_LOG=$(cat generated-code/execution.log)
            echo "exec_log<<EOF" >> $GITHUB_OUTPUT
            echo "$EXEC_LOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "exec_log=No execution log found" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request with Generated Code
        id: create_pr
        if: steps.generate.outputs.generation_success == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "AI Generated: ${{ steps.extract_topic.outputs.title || steps.extract_dispatch.outputs.title }}"
          title: "[AI Code] ${{ steps.extract_topic.outputs.title || steps.extract_dispatch.outputs.title }}"
          body: |
            ## Topic
            ${{ steps.extract_topic.outputs.title || steps.extract_dispatch.outputs.title }}
            
            ## Description
            Automatically generated by AI Coding Agent
            
            ### Generated Files
            - See `generated-code/` directory for all generated files
            - `generated-code/main.py` or `main.js` - Entry point
            - `generated-code/requirements.txt` (if Python) - Dependencies
            - `generated-code/execution.log` - Execution output
            
            ### Execution Results
            ```
            ${{ steps.logs.outputs.exec_log }}
            ```
            
            ### How to Use
            1. Review generated code in this PR
            2. Run locally: See the README in generated-code/
            3. Suggest improvements by commenting on this PR
            4. Merge when satisfied
            
            ---
            Generated by [AI Coding Agent](https://github.com/${{ github.repository }})
          branch: "agent/code-${{ github.run_number }}"
          labels: "ai-generated"
          delete-branch: true
      
      - name: Comment on Issue with Success
        if: steps.extract_topic.outputs.processing == 'true' && steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.extract_topic.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **AI Code Generation Complete!**\n\n' +
                    '**Topic:** ${{ steps.extract_topic.outputs.title }}\n\n' +
                    'Generated code and logs are available in PR #${{ steps.create_pr.outputs.pull-request-number }}\n\n' +
                    '[View Generated Code →](${{ steps.create_pr.outputs.pull-request-url }})'
            })
      
      - name: Comment on Issue with Failure
        if: steps.extract_topic.outputs.processing == 'true' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.extract_topic.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **AI Code Generation Failed**\n\n' +
                    '**Topic:** ${{ steps.extract_topic.outputs.title }}\n\n' +
                    'Check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

  summary:
    runs-on: ubuntu-latest
    needs: ai-code-generation
    if: always()
    steps:
      - name: Workflow Summary
        run: |
          echo "## AI Coding Agent Workflow Summary"
          echo "Status: ${{ job.status }}"
          echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
